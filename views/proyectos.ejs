<!-- proyectos.ejs -->

<h4 class="mb-4">Catálogo de Proyectos</h4>
<div id="seleccionProyecto" class="mb-3 text-muted fw-semibold"></div>
<div class="d-flex flex-wrap gap-2 mb-3">

  <button id="btnAgregarProyecto" class="btn btn-primary d-flex align-items-center gap-2" onclick="agregarFila()">
    <i class="bi bi-plus-circle"></i>
    Agregar Proyecto
  </button>

  <button class="btn btn-secondary d-flex align-items-center gap-2" onclick="mostrarProyectosEliminados()">
    <i class="bi bi-archive"></i>
    Ver eliminados
  </button>

  <button class="btn btn-info text-white d-flex align-items-center gap-2" onclick="mostrarGraficaRamas()">
    <i class="bi bi-bar-chart"></i>
    Gráfica Direcciones
  </button>

  <button class="btn btn-dark d-flex align-items-center gap-2" onclick="mostrarGraficaIndicadores()">
    <i class="bi bi-graph-up-arrow"></i>
    Gráfico Indicadores
  </button>

  <button class="btn btn-success d-flex align-items-center gap-2" onclick="mostrarGraficaIntegrantes()">
    <i class="bi bi-people-fill"></i>
    Gráfica Integrantes
  </button>

<button class="btn btn-danger" onclick="exportarGraficaGeneral()">
  <i class="bi bi-file-earmark-pdf"></i> Exportar PDF
</button>

<button class="btn btn-outline-dark" onclick="exportarResumenPorRamaPDF()">
  <i class="bi bi-filetype-pdf"></i> Exportar Reporte de Integrantes
</button>

  
</div>





  <div class="table-responsive">
    <table
      id="tablaProyectos"
      class="table table-striped table-hover table-bordered"
      style="width: 100%"
    >
<thead class="table-dark">
  <tr>
    <th style="min-width: 150px;" class="text-center">ID</th>
    <th style="min-width:  150px;">Proyecto</th>
    <th style="min-width:  150px;">Rama</th>
    <th style="min-width:  150px;">Descripción</th>
    <th style="min-width:  150px;">Tipo</th>
    <th style="min-width:  150px;">Departamento(s)</th>
    <th style="min-width:  150px;">Área(s)</th>
    <th style="min-width:  150px;">Integrante(s)</th>
    <th style="min-width:  150px;">Inicio</th>
    <th style="min-width:  150px;">Fin</th>
    <th style="min-width: 150px;" class="text-center">%</th>
    <th style="min-width:  150px;" class="text-center">Indicador</th>
    <th style="min-width:  150px;" class="text-center">Acciones</th>
  </tr>
</thead>

      <tbody id="cuerpoTablaProyectos">
        <% proyectos.forEach((p, index) => { %>
        <tr
          data-bs-toggle="collapse"
          data-bs-target="#detalle<%= index %>"
          style="cursor: pointer"
        >
          <td><%= p.id %></td>
          <td><%= p.nombre %></td>
          <td><%= p.rama %></td>
          <td><%= p.descripcion %></td>
          <td><%= p.tipo_proyecto %></td>
          <td><%= p.departamento %></td>
          <td><%= p.area %></td>
          <td><%= p.integrantes %></td>
          <td><%= p.fecha_inicio.toISOString().split('T')[0] %></td>
          <td><%= p.fecha_fin.toISOString().split('T')[0] %></td>
          <td><%= p.porcentaje %> %</td>
          <td><%= p.estatus %></td>
          

         
            <td class="text-center">
              <button
                class="btn btn-sm btn-outline-secondary me-1"
              onclick="agregarFila()"
                title="Agregar Proyecto"
              >
                <i class="bi bi-database-fill-gear"></i>
              </button>

              <button
                class="btn btn-sm btn-outline-warning"
                onclick="editarProyecto(this)"
                title="Editar"
              >
                <i class="bi bi-pencil-square"></i>
              </button>
              <button class="btn btn-sm btn-danger" onclick="eliminarProyecto(<%= p.id %>)">
                <i class="bi bi-trash3-fill"></i>
              </button>

            </td>
                        
     
        </tr>

        <% }) %>
      </tbody>
    </table>
  </div>
</div>
<canvas id="graficaRamasPDF" width="600" height="300" style="display:none;"></canvas>

<!-- Definimos la lista de integrantes como variable global JS -->
<script>

  const integrantes = <%- JSON.stringify(integrantes || []) %>;
  console.log("Integrantes disponibles:", integrantes); // Para depurar
</script>

<datalist id="listaIntegrantes">
  <% integrantes.forEach(p => { %>
  <option
    value="<%= p.nombre_sin_apellidos %> <%= p.apellido_paterno %> <%= p.apellido_materno %>"
  >
    <% }) %>
  </option>
</datalist>

<datalist id="listaAreas">
  <% (areas || []).forEach(d => { %>
  <option value="<%= d.nombre %>"><% }) %></option>
</datalist>

<datalist id="listaDepartamentos">
  <option value="Sistemas">
  <option value="Compras">
  <!-- Agrega más aquí si los tienes -->
</datalist>
<!-- Cargamos el script con lógica de agregar filas -->
<!--<script src="/js/proyecto.js"></script>-->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const tbody = document.getElementById("cuerpoTablaProyectos");
    const botonAgregar = document.getElementById("btnAgregarProyecto");

    if (tbody.children.length === 0) {
      // Mostrar el botón si no hay datos
      botonAgregar.style.display = "inline-block";
    } else {
      // Ocultar el botón si ya hay registros
      botonAgregar.style.display = "none";
    }
  });
</script>


<!-- Modal -->
<div class="modal fade" id="modalProyectosEliminados" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Proyectos Eliminados</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <table class="table table-bordered table-hover table-sm">
          <thead class="table-dark">
            <tr>
              <th>ID</th>
              <th>Proyecto</th>
              <th>Rama</th>
              <th>Descripción</th>
              <th>Tipo</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tbodyEliminados">
            <!-- Aquí se inyectarán los eliminados -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
  <!-- Modal Graficas Pastel DIRECTORES-->

<div class="modal fade" id="modalGraficaRamas" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content p-3">
      <div class="modal-header">
        <h5 class="modal-title">Distribución de proyectos por rama</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <canvas id="graficaRamas"></canvas>
      </div>
    </div>
  </div>
</div>


<!-- Modal gráfico por DIRECTORES e indicador -->
<div class="modal fade" id="modalGraficaIndicadores" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content p-3">
      <h5 class="text-center">Indicadores por Rama</h5>
      <canvas id="graficaIndicadores" style="max-height: 400px;"></canvas>
    </div>
  </div>
</div>


<!-- Modal para gráfica de integrantes -->
<div class="modal fade" id="modalGraficaIntegrantes" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content p-3">
      <h5 class="text-center">Proyectos por Integrante y Rama</h5>
      <canvas id="graficaIntegrantes" style="max-height: 400px;"></canvas>
    </div>
  </div>
</div>

